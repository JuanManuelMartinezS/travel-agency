<!-- Page header -->
<div class="mb-8">
  <div class="flex items-center justify-between">
    <div>
      @if (mode() === 1) {
      <h1 class="text-foreground text-2xl font-semibold">Roles del Usuario</h1>
      <p class="text-muted-foreground mt-1 text-sm">Ver roles asignados al usuario</p>
      } @else if (mode() === 2) {
      <h1 class="text-foreground text-2xl font-semibold">Asignar Roles al Usuario</h1>
      <p class="text-muted-foreground mt-1 text-sm">Seleccione los roles que desea asignar</p>
      } @else if (mode() === 3) {
      <h1 class="text-foreground text-2xl font-semibold">Actualizar Roles del Usuario</h1>
      <p class="text-muted-foreground mt-1 text-sm">Modificar los roles asignados al usuario</p>
      }
    </div>
    <div>
      <app-button impact="light" tone="light" (buttonClick)="back()"> Volver al listado </app-button>
    </div>
  </div>
</div>

<!-- Form card -->
<div class="border-muted/20 bg-background rounded-xl border p-6">
  <form class="space-y-6" [formGroup]="theFormGroup">
    <!-- User ID Field (oculto) -->
    <input type="hidden" formControlName="userId" />

    <!-- Loading state -->
    @if (loading()) {
    <div class="flex items-center justify-center py-8">
      <div class="border-primary h-8 w-8 animate-spin rounded-full border-b-2"></div>
      <span class="text-foreground ml-2">Cargando roles...</span>
    </div>
    } @else {

    <!-- Roles Selection -->
    <div class="space-y-4">
      <label class="text-foreground text-sm font-medium">
        Seleccionar Roles <span class="text-destructive">*</span>
      </label>

      <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3" formArrayName="selectedRoles">
        @for (role of roles(); track role._id; let i = $index) {
        <div class="border-muted/20 hover:bg-muted/5 flex items-center space-x-3 rounded-lg border p-3">
          <input
            type="checkbox"
            [id]="'role-' + i"
            [formControlName]="i"
            [disabled]="isViewMode()"
            class="text-primary border-muted/20 focus:ring-primary h-4 w-4 rounded focus:ring-2" />

          <label [for]="'role-' + i" class="flex-1 cursor-pointer">
            <div class="text-foreground font-medium">{{ role.name }}</div>
            <div class="text-muted-foreground text-sm">{{ role.description || 'Sin descripci贸n' }}</div>
          </label>
        </div>
        }
      </div>

      <!-- Validation message -->
      @if (selectedRolesControl?.errors && (selectedRolesControl?.dirty || selectedRolesControl?.touched || trySend()))
      {
      <div class="text-destructive space-y-1 text-xs">
        @if (selectedRolesControl?.errors?.['required']) {
        <div>Debe seleccionar al menos un rol</div>
        } @if (selectedRolesControl?.errors?.['minlength']) {
        <div>Debe seleccionar al menos un rol</div>
        }
      </div>
      }
    </div>

    <!-- Informaci贸n de roles actuales (solo en modo view y update) -->
    @if (!isCreateMode() && userRoles().length > 0) {
    <div class="bg-muted/10 space-y-4 rounded-lg p-4">
      <h3 class="text-foreground font-medium">Roles Actualmente Asignados</h3>
      <div class="flex flex-wrap gap-2">
        @for (userRole of userRoles(); track userRole._id) {
        <span class="bg-primary/10 text-primary inline-flex items-center rounded-full px-3 py-1 text-xs font-medium">
          {{ userRole.role.name }}
          @if (userRole.role.description) {
          <span class="text-muted-foreground ml-1">({{ userRole.role.description }})</span>
          }
        </span>
        }
      </div>
    </div>
    }

    <!-- Resumen de selecci贸n (solo en modo create y update) -->
    @if (!isViewMode()) {
    <div class="bg-success/10 space-y-4 rounded-lg p-4">
      <h3 class="text-foreground font-medium">Resumen de Selecci贸n</h3>
      <p class="text-foreground">
        Roles seleccionados: <strong>{{ getSelectedRoleIds().length }}</strong>
      </p>
      <div class="flex flex-wrap gap-2">
        @for (roleId of getSelectedRoleIds(); track roleId) {
        <span class="bg-success/20 text-success inline-flex items-center rounded-full px-2 py-1 text-xs font-medium">
          {{ getRoleName(roleId) }}
        </span>
        }
      </div>
    </div>
    }

    <!-- Action buttons -->
    <div class="border-muted/20 border-t pt-6">
      <div class="flex justify-end gap-3">
        <!-- View mode button -->
        @if (isViewMode()) {
        <app-button impact="bold" tone="primary" (buttonClick)="back()"> Regresar </app-button>
        }

        <!-- Create mode buttons -->
        @if (isCreateMode()) {
        <app-button impact="light" tone="light" (buttonClick)="back()"> Cancelar </app-button>
        <app-button impact="bold" tone="success" (buttonClick)="create()" [disabled]="loading()">
          {{ loading() ? 'Asignando...' : 'Asignar Roles' }}
        </app-button>
        }

        <!-- Update mode buttons -->
        @if (isUpdateMode()) {
        <app-button impact="light" tone="light" (buttonClick)="back()"> Cancelar </app-button>
        <app-button impact="bold" tone="warning" (buttonClick)="update()" [disabled]="loading()">
          {{ loading() ? 'Actualizando...' : 'Actualizar Roles' }}
        </app-button>
        }
      </div>
    </div>
    }
  </form>
</div>
